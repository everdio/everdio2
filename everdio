#!/usr/bin/env php

<?php
\ini_set("memory_limit", "1536M");
\date_default_timezone_set("Europe/Amsterdam");
\setlocale(\LC_TIME, "nl_NL.utf8");
\ini_set('intl.default_locale', 'nl-NL');
\ini_set('display_errors', '1'); 

include_once(__DIR__ . \DIRECTORY_SEPARATOR . "everdio.php");

$cli = new \Component\Core\Controller\Model\Cli;
$cli->server = $_SERVER;
$cli->path = __DIR__;
$cli->debug = "_debug";
$cli->setup();
$cli->throttle(["php"]);

$cli->echo("Everdio2 CommandLine", ["yellow", "bold", "underline"]);
$cli->break(2);
if (!isset($cli->execute)) {
    $cli->echo("Provide a valid execute path ..", ["lightgray", "bold"]);
    $cli->break(2);
    exit;
}

$cli->echo("Pid:\t\t", ["lightgray"]);
$cli->echo($cli->pid, ["green"]);
$cli->break();
$cli->echo("Timestamp:\t", ["lighgray"]);
$cli->echo(\date("Y-m-d H:i:s"), ["green"]);
$cli->break();
$cli->echo("Execute:\t", ["lighgray"]);
$cli->echo($cli->execute, ["bold"]);
$cli->break();

if (isset($cli->arguments)) {
    $cli->echo("Arguments:\t", ["lighgray"]);
    $cli->echo($cli->arguments, ["bold"]);
    $cli->break();
}

$cli->echo("Request:\t", ["lighgray"]);
$cli->echo($cli->dehydrate($cli->request->restore()), ["bold"]);
$cli->break(2);

try {
    $cli->execute(\DIRECTORY_SEPARATOR . $cli->execute);
} catch (\Exception $ex) {
    if (isset($cli->request->{$cli->debug})) {
        throw new \RuntimeException($ex->getMessage(), 0, $ex);
    }
    
    $cli->break();
    $cli->echo($ex->getMessage(), ["red", "bold"]);
    $cli->break();
}

$cli->break();
$cli->echo("Time:\t", ["lightgray"]);
$cli->echo(\sprintf("%ss", \gmdate("H:i:s", $cli->getTimer(0))), ["green"]);
$cli->break();
$cli->echo("Memory:\t", ["lightgray"]);
$cli->echo($cli->getSizeformat(\memory_get_peak_usage(true)), ["green"]);
$cli->break(2);
exit;