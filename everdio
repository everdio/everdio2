#!/usr/bin/env php

<?php
\ini_set("memory_limit", "1536M");
\date_default_timezone_set("Europe/Amsterdam");
\setlocale(\LC_TIME, "nl_NL.utf8");
\ini_set('intl.default_locale', 'nl-NL');
\ini_set('display_errors', '1'); 

include_once(__DIR__ . \DIRECTORY_SEPARATOR . "everdio.php");

$controller = new \Component\Core\Controller\Model\Cli(__DIR__);
$controller->server = $_SERVER;
$controller->debug = "_debug";
$controller->path = __DIR__;
$controller->setup();
$controller->echo("Everdio2 CommandLine", ["yellow", "bold", "underline"]);
$controller->break(2);

if (!isset($controller->execute)) {
    $controller->echo("Provide a valid execute path ..", ["lightgray", "bold"]);
    $controller->break(2);
    exit;
}

$controller->echo("Pid:\t\t", ["lightgray"]);
$controller->echo($controller->pid, ["green"]);
$controller->break();
$controller->echo("Timestamp:\t", ["lighgray"]);
$controller->echo(\date("Y-m-d H:i:s"), ["green"]);
$controller->break();
$controller->echo("Execute:\t", ["lighgray"]);
$controller->echo($controller->execute, ["bold"]);
$controller->break();

if (isset($controller->arguments)) {
    $controller->echo("Arguments:\t", ["lighgray"]);
    $controller->echo($controller->arguments, ["bold"]);
    $controller->break();
}

$controller->echo("Request:\t", ["lighgray"]);
$controller->echo($controller->dehydrate($controller->request->restore()), ["bold"]);
$controller->break(2);

try {
    $controller->execute(\DIRECTORY_SEPARATOR . $controller->execute);
} catch (\Exception $ex) {
    if (isset($controller->request->{$controller->debug})) {
        throw new \RuntimeException(\ucfirst($ex->getMessage()), 0, $ex);
    }
    
    $controller->break();
    $controller->echo(\ucfirst($ex->getMessage()), ["red", "bold"]);
    $controller->break();
}

$controller->break();
$controller->echo("Time:\t", ["lightgray"]);
$controller->echo(\sprintf("%ss", \gmdate("H:i:s", \round($controller->getTimer())), 3), ["green"]);
$controller->break();
$controller->echo("Memory:\t", ["lightgray"]);
$controller->echo($controller->getSizeformat(\memory_get_peak_usage(true)), ["green"]);
$controller->break(2);
exit;