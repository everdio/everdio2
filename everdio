#!/usr/bin/env php
<?php
\ini_set("memory_limit", "1536M");
\date_default_timezone_set("Europe/Amsterdam");
\setlocale(\LC_TIME, "nl_NL.utf8");
\ini_set('intl.default_locale', 'nl-NL');
\ini_set('display_errors', '1'); 

include_once(__DIR__ . \DIRECTORY_SEPARATOR . "everdio.php");

$controller = new \Component\Core\Controller\Model\Cli;
$controller->self = __FILE__;
$controller->server = $_SERVER;
$controller->debug = "_debug";
$controller->path = __DIR__;        
$controller->setup();

try {
    if (isset($controller->request->_pid)) {
        $cache = new \Component\Caller\File\Fopen\Cache($controller->request->_pid);
        if ($cache->exists() && $cache->lock(\LOCK_EX)) {
            $controller->import($cache->read());
            $controller->dispatch($controller->arguments);
            $cache->lock(\LOCK_UN);  
            $cache->delete();
        } else {
            throw new \LogicException(\sprintf("Unknown pid %s", $controller->request->_pid));
        }
    } else {
        $controller->execute(\DIRECTORY_SEPARATOR . $controller->arguments);
    }    
} catch (\Exception $ex) {
    if (isset($controller->request->{$controller->debug})) {
        throw new \RuntimeException(\ucfirst($ex->getMessage()), 0, $ex);
    }
    
    $controller->break();
    $controller->echo(\ucfirst($ex->getMessage()), ["red", "bold"]);
    $controller->break(2);
}

/*
$time = \microtime(true);
$controller->echo("Everdio2 CommandLine", ["yellow", "bold", "underline"]);
$controller->break(2);

if (!isset($controller->execute)) {
    $controller->echo("Provide a valid execute path ..", ["lightgray", "bold"]);
    $controller->break(2);
    exit;
}

$controller->echo("Timestamp:\t", ["lighgray"]);
$controller->echo(\date("Y-m-d H:i:s"), ["green"]);
$controller->break();
$controller->echo("Execute:\t", ["lighgray"]);
$controller->echo($controller->execute, ["bold"]);
$controller->break();

if (isset($controller->arguments)) {
    $controller->echo("Arguments:\t", ["lighgray"]);
    $controller->echo($controller->arguments, ["bold"]);
    $controller->break();
}

$controller->echo("Request:\t", ["lighgray"]);
$controller->echo($controller->dehydrate($controller->request->restore()), ["bold"]);
$controller->break(2);

try {
    $controller->execute(\DIRECTORY_SEPARATOR . $controller->execute);    
} catch (\Exception $ex) {
    if (isset($controller->request->{$controller->debug})) {
        throw new \RuntimeException(\ucfirst($ex->getMessage()), 0, $ex);
    }
    $controller->break();
    $controller->echo(\ucfirst($ex->getMessage()), ["red", "bold"]);
    $controller->break();
}

$controller->break();
$controller->echo("Time:\t\t", ["lightgray"]);
$controller->echo(\sprintf("%ss", \gmdate("H:i:s", \round(\microtime(true) - $time))), ["green"]);
$controller->break(2);
 * 
 */
exit;